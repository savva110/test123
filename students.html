<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–µ–Ω–∏–∫–∏ ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <style>
        :root { --page-min-h: 590px; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin:0; padding:10px; background: var(--tg-theme-bg-color,#0f1720); color: var(--tg-theme-text-color,#e5e7eb); box-sizing: border-box; overflow-x: hidden; }
        .page { display:flex; flex-direction:column; width:100%; max-width:min(720px,100vw); margin:0 auto; }
        h1 { margin:0 0 10px; font-size:18px; }
        .content { display:flex; flex-direction:column; flex:1 1 auto; }
        .main { flex:1 1 auto; overflow:auto; padding-bottom:80px; }
        .footer { position:fixed; bottom:0; left:0; right:0; background:var(--tg-theme-bg-color,#0f1720); padding:10px; box-shadow:0 -4px 10px rgba(0,0,0,0.3); z-index:10; }
        .section { background:var(--tg-theme-secondary-bg-color,#111827); border-radius:12px; padding:10px; border-left:4px solid var(--tg-theme-button-color,#2481cc); margin-bottom:10px; }
        .row { display:flex; gap:8px; align-items:center; }
        .row-top { margin-bottom:6px; display:grid; grid-template-columns: 1fr; gap:8px; }
        .row-bottom { justify-content:space-between; flex-wrap:wrap; gap:10px; }
        .row input[type="text"] { flex:1; padding:8px; border:2px solid var(--tg-theme-hint-color,#374151); background:transparent; color:inherit; border-radius:8px; font-size:14px; min-width:0; }
        .row label { display:flex; align-items:center; gap:6px; font-size:13px; white-space:nowrap; }
        .buttons { display:flex; gap:8px; margin-top:8px; }
        .buttons a, .buttons button, #save-all { display:block; width:100%; text-decoration:none; text-align:center; background:var(--tg-theme-button-color,#2481cc); color:var(--tg-theme-button-text-color,#fff); padding:12px; border-radius:12px; border:none; font-size:14px; }
        #save-all.disabled { opacity:.6; pointer-events:none; }
        .ghost { background:transparent; color:var(--tg-theme-button-color,#93c5fd); border:1px solid var(--tg-theme-button-color,#2481cc); }
        .item { background:#ffffff10; border-radius:10px; padding:10px; margin-top:8px; }
        .rm { background:#ef4444; color:#fff; border:none; border-radius:10px; padding:10px 12px; }
        .rm:active { opacity:.9; }
        .rm.disabled { opacity:.6; pointer-events:none; cursor:default; }
        .toggle { background:#ffffff08; border:1px solid var(--tg-theme-hint-color,#374151); border-radius:10px; padding:6px 10px; }
        .toggle input[type="checkbox"] { width:16px; height:16px; }
        /* Subgroup select styled as a single standalone control */
        select.subgroup { 
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background:#ffffff08; 
            border:1px solid var(--tg-theme-hint-color,#374151); 
            border-radius:10px; 
            padding:10px 0px 6px 12px; 
            color:inherit; 
            font-size:14px; 
            line-height:1.35;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23a3a3a3' d='M1.41.59 6 5.17 10.59.59 12 2l-6 6L0 2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px 8px;
        }
        .row-bottom select.subgroup { min-width: 140px; }
        select.subgroup:focus { outline: 2px solid var(--tg-theme-button-color,#2481cc); outline-offset: 2px; }
        /* Try to slightly lower option text in some browsers */
        select.subgroup option { 
            padding-top: 6px; 
            padding-bottom: 4px; 
            background: var(--tg-theme-secondary-bg-color,#111827); 
            color: var(--tg-theme-text-color,#e5e7eb);
        }
        select.subgroup optgroup { 
            background: var(--tg-theme-secondary-bg-color,#111827); 
            color: var(--tg-theme-text-color,#e5e7eb);
        }
        .hint { font-size:12px; opacity:.7; margin:6px 0 0; }
        /* Pointer cursor on interactive elements */
        .buttons button, #save-all, .rm:not(.disabled), .toggle, input[type="checkbox"] { cursor: pointer; }

        @media (min-width:420px) {
            .section { padding:12px; }
            .item { padding:12px; }
            .row-top { margin-bottom:8px; grid-template-columns: 1fr 1fr; }
            .row-bottom { gap:12px; }
            .row input[type="text"] { font-size:15px; }
            #save-all { width:100%; }
        }

        @media (min-width:600px) {
            .item { display:flex; align-items:center; gap:12px; }
            .row-top { flex:1 1 auto; margin:0; grid-template-columns: 1fr 1fr 1fr; }
            .row-bottom { flex:0 0 auto; margin:0; justify-content:flex-end; gap:12px; }
            .row-bottom > div { display:flex; align-items:center; gap:10px; }
        }

        /* –ù–∞ —Å—Ä–µ–¥–Ω–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –¥–µ–ª–∞–µ–º –ø–æ–ª–µ –∫–æ–¥–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        @media (min-width:420px) and (max-width:599.98px) {
            .row-top .code { grid-column: 1 / -1; }
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="page">
        <div class="content">
            <div class="main">
                <h1>üë• –£—á–µ–Ω–∏–∫–∏</h1>
                <div class="section" id="students-section">
                    <h3>‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–æ–≤</h3>
                    <p class="hint">–ü–æ–ª—è: –∏–º—è, —Ñ–∞–º–∏–ª–∏—è, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥, —Ñ–ª–∞–∂–æ–∫ —Å—Ç–∞—Ä–æ—Å—Ç–∞, –ø–æ–¥–≥—Ä—É–ø–ø–∞.</p>
                    <div id="students-list"></div>
                    <div class="buttons"><button id="add-student" class="ghost">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button></div>
                </div>
            </div>
        </div>
        <div class="footer">
            <button id="save-all">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();

        const list = document.getElementById('students-list');
        const saveBtn = document.getElementById('save-all');
        const urlParams = new URLSearchParams(location.search);
        function getSubgroupsCount(){
            const raw = urlParams.get('subgroups');
            const n = Number(raw);
            if (!Number.isFinite(n) || n < 1) return 1;
            return Math.min(Math.max(1, Math.floor(n)), 10);
        }
        const SUBGROUPS_COUNT = getSubgroupsCount();
        function getPrefilledStudents(){
            try { return JSON.parse(urlParams.get('students')||'[]'); } catch { return []; }
        }
        const prefilledStudents = getPrefilledStudents();

        function setDisabled(btn, disabled){
            if (!btn) return;
            if (disabled){ btn.classList.add('disabled'); btn.setAttribute('disabled','disabled'); }
            else { btn.classList.remove('disabled'); btn.removeAttribute('disabled'); }
        }
        function getSelectedSubgroup(row){
            const sel = row.querySelector('select.subgroup');
            if (!sel) return 1;
            const v = Number(sel.value);
            if (!Number.isFinite(v) || v < 1) return 1;
            return Math.min(v, SUBGROUPS_COUNT);
        }
        function normalizeStudentRowData(row){
            const inputs = row.querySelectorAll('input[type="text"]');
            const f = String(inputs[0]?.value || '').trim();
            const l = String(inputs[1]?.value || '').trim();
            const cEl = inputs[2] || null;
            const c = cEl ? String(cEl.value || '').trim() : '';
            const cb = row.querySelector('input[type="checkbox"]');
            const leader = cb ? Boolean(cb.checked) : false;
            const hasId = row.hasAttribute('data-user-id');
            const id = hasId ? Number(row.dataset.userId) : null;
            const subgroup = getSelectedSubgroup(row);
            return { id, first_name: f, last_name: l, code: c, leader, subgroup };
        }
        function areStudentsEqual(a, b){
            if (!Array.isArray(a) || !Array.isArray(b)) return false;
            if (a.length !== b.length) return false;
            for (let i=0;i<a.length;i++){
                const x=a[i], y=b[i];
                if ((x.id??null)!==(y.id??null)) return false;
                if (String(x.first_name||'')!==String(y.first_name||'')) return false;
                if (String(x.last_name||'')!==String(y.last_name||'')) return false;
                if ((x.id??null)===null){ // —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–¥
                    if (String(x.code||'')!==String(y.code||'')) return false;
                }
                if (Boolean(x.leader)!==Boolean(y.leader)) return false;
                if (Number(x.subgroup||1)!==Number(y.subgroup||1)) return false;
            }
            return true;
        }
        function snapshotCurrentStudents(){
            const rows = list.querySelectorAll('.item');
            const res = [];
            rows.forEach(r => res.push(normalizeStudentRowData(r)));
            return res;
        }
        let initialSnapshot = [];
        function refreshSaveState(){
            const current = snapshotCurrentStudents();
            setDisabled(saveBtn, areStudentsEqual(initialSnapshot, current));
        }

        function createSubgroupSelect(selected = 1){
            const sel = document.createElement('select');
            sel.className = 'subgroup';
            for (let i=1;i<=SUBGROUPS_COUNT;i++){
                const opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = `–ü–æ–¥–≥—Ä—É–ø–ø–∞ ${i}`;
                if (i===Number(selected)) opt.selected = true;
                sel.appendChild(opt);
            }
            sel.addEventListener('change', refreshSaveState);
            return sel;
        }
        function createStudentRow(firstName = '', lastName = '', code = '', isLeader = false, id = null, subgroup = 1, role = 0){
            const wrap = document.createElement('div');
            wrap.className = 'item';
            wrap.innerHTML = `
                <div class="row row-top">
                    <input class="first" type="text" placeholder="–ò–º—è" value="${String(firstName).replaceAll('"','&quot;')}">
                    <input class="last" type="text" placeholder="–§–∞–º–∏–ª–∏—è" value="${String(lastName).replaceAll('"','&quot;')}">
                    <input class="code" type="text" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥" value="${String(code).replaceAll('"','&quot;')}">
                </div>
                <div class="row row-bottom">
                    <label class="toggle"><input type="checkbox" ${isLeader ? 'checked' : ''}> –°—Ç–∞—Ä–æ—Å—Ç–∞</label>
                    <button class="rm">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            if (id !== null && id !== undefined) { wrap.dataset.userId = String(id); }
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —É—á–∞—Å—Ç–Ω–∏–∫ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–¥–∞
            if (id !== null && id !== undefined) {
                const codeInput = wrap.querySelector('.code');
                if (codeInput) codeInput.style.display = 'none';
            }
            // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –ø–æ–¥–≥—Ä—É–ø–ø—ã –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ —É—á–∏—Ç–µ–ª—å
            const rowBottom = wrap.querySelector('.row-bottom');
            if (rowBottom && Number(role)!==2){
                const sel = createSubgroupSelect(Math.min(Math.max(1, Number(subgroup)||1), SUBGROUPS_COUNT));
                rowBottom.insertBefore(sel, rowBottom.querySelector('.rm'));
            }
            wrap.querySelector('.rm').onclick = () => { wrap.remove(); refreshSaveState(); };
            // –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            const inputs = wrap.querySelectorAll('input[type="text"], input[type="checkbox"]');
            inputs.forEach(inp => inp.addEventListener(inp.type==='checkbox'?'change':'input', refreshSaveState));
            return wrap;
        }

        function render(){
            list.innerHTML = '';
            if (Array.isArray(prefilledStudents) && prefilledStudents.length) {
                prefilledStudents.forEach(s => {
                    const f = String((s && s.first_name) || '');
                    const l = String((s && s.last_name) || '');
                    const leader = Boolean((s && s.leader) || false);
                    const id = (s && (s.id ?? s.user_id)) ?? null;
                    const role = Number((s && s.role) ?? 0);
                    const subgroup = Math.min(Number((s && s.subgroup) ?? 1) || 1, SUBGROUPS_COUNT);
                    const row = createStudentRow(f, l, '', leader, id, subgroup, role);
                    if (role === 2) {
                        // –£—á–∏—Ç–µ–ª—å: —É–±–∏—Ä–∞–µ–º —á–µ–∫–±–æ–∫—Å —Å—Ç–∞—Ä–æ—Å—Ç—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
                        const toggle = row.querySelector('.toggle');
                        if (toggle) toggle.remove();
                        const label = document.createElement('div');
                        label.className = 'hint';
                        label.textContent = '–£—á–∏—Ç–µ–ª—å';
                        const rmBtn = row.querySelector('.rm');
                        row.querySelector('.row-bottom').insertBefore(label, rmBtn);
                        // –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —É—á–∏—Ç–µ–ª—è
                        if (rmBtn) { rmBtn.classList.add('disabled'); rmBtn.setAttribute('disabled', 'disabled'); rmBtn.onclick = null; }
                    }
                    list.appendChild(row);
                });
            } else {
                list.appendChild(createStudentRow('', '', '', false, null, 1, 0));
            }
            initialSnapshot = snapshotCurrentStudents();
            refreshSaveState();
        }

        function collectStudents(){
            const rows = list.querySelectorAll('.item');
            const res = [];
            const currentIds = new Set();
            
            rows.forEach(r => {
                const inputs = r.querySelectorAll('input[type="text"]');
                const f = inputs[0].value.trim();
                const l = inputs[1].value.trim();
                const c = inputs[2] ? inputs[2].value.trim() : '';
                const cb = r.querySelector('input[type="checkbox"]');
                const leader = cb ? cb.checked : false;
                const hasId = r.hasAttribute('data-user-id');
                const id = hasId ? Number(r.dataset.userId) : null;
                const subgroup = getSelectedSubgroup(r);
                
                // –î–ª—è –Ω–æ–≤—ã—Ö —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–¥, –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö (id) –∫–æ–¥ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
                if (id !== null) {
                    currentIds.add(id);
                    if (f && l) res.push({ id, first_name: f, last_name: l, leader, subgroup });
                } else {
                    if (f && l && c) res.push({ first_name: f, last_name: l, code: c, leader, subgroup });
                }
            });
            
            // –ù–∞—Ö–æ–¥–∏–º —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤ (–±—ã–ª–∏ –≤ initialSnapshot, –Ω–æ –Ω–µ—Ç –≤ —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ)
            const removedIds = [];
            initialSnapshot.forEach(student => {
                if (student.id !== null && !currentIds.has(student.id)) {
                    removedIds.push(student.id);
                }
            });
            
            return { students: res, removedIds: removedIds };
        }

        document.getElementById('add-student').onclick = () => { list.appendChild(createStudentRow()); refreshSaveState(); };
        document.getElementById('save-all').onclick = () => {
            const data = collectStudents();
            tg.sendData(JSON.stringify({ action: 'add_students', students: data.students, removedIds: data.removedIds }));
            // –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –∫–æ–¥–∞ —É –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
            const rows = list.querySelectorAll('.item');
            rows.forEach(r => {
                if (!r.dataset.userId) {
                    const codeInput = r.querySelector('.code');
                    if (codeInput && codeInput.value.trim()) {
                        codeInput.value = '';
                        codeInput.style.display = 'none';
                    }
                }
            });
            // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–Ω–∞–ø—à–æ—Ç –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            initialSnapshot = snapshotCurrentStudents();
            refreshSaveState();
        };

        render();
    </script>
</body>
</html>
