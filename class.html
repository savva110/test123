<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∞—Å—Å ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin:0; padding:16px; background: var(--tg-theme-bg-color,#fff); color: var(--tg-theme-text-color,#000); }
        h1 { margin: 0 0 12px; font-size: 20px; }
        .section { background: var(--tg-theme-secondary-bg-color,#f5f5f5); border-radius: 12px; padding: 14px; border-left: 4px solid var(--tg-theme-button-color,#2481cc); margin-bottom: 12px; }
        .row { display:flex; gap:8px; align-items:center; }
        input[type="text"] { flex: 1; padding: 10px; border: 2px solid var(--tg-theme-hint-color,#ccc); border-radius: 10px; font-size: 14px; }
        .buttons { display:flex; gap:8px; margin-top: 12px; }
        .buttons button { background: var(--tg-theme-button-color,#2481cc); color: var(--tg-theme-button-text-color,#fff); border:none; padding:12px 14px; border-radius:10px; }
        .ghost { background: transparent; color: var(--tg-theme-button-color,#2481cc); border:1px solid var(--tg-theme-button-color,#2481cc); }
        .disabled { opacity:.6; pointer-events:none; }
        .danger { background: #e53935 !important; color: #fff; }
        .success { background: #43a047 !important; color: #fff; }
        .status { margin-top: 12px; padding: 10px; border-radius: 8px; text-align: center; font-weight: 500; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        /* Pointer cursor on interactive elements */
        .buttons button, button, input[type="checkbox"] { cursor: pointer; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>üè∑Ô∏è –ö–ª–∞—Å—Å</h1>
    <div class="section">
        <h3>üìù –ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞</h3>
        <div class="row"><input id="class-name" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7–ê" maxlength="50"></div>
        <div class="buttons"><button id="save-name">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        <div id="status"></div>
    </div>
    <div class="section">
        <h3>üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–≥—Ä—É–ø–ø</h3>
        <div class="row" id="subgroups-options" style="gap:6px;">
            <label><input type="radio" name="subgroups" value="1"> 1</label>
            <label><input type="radio" name="subgroups" value="2"> 2</label>
            <label><input type="radio" name="subgroups" value="3"> 3</label>
            <label><input type="radio" name="subgroups" value="4"> 4</label>
        </div>
        <div class="buttons"><button id="save-subgroups">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        <div id="status-subgroups"></div>
    </div>
    <div class="section">
        <h3>‚ö†Ô∏è –†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å</h3>
        <p>–î–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –∫–ª–∞—Å—Å –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
        <div class="buttons">
            <button id="disband-toggle" class="ghost">–†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å</button>
        </div>
        <div id="confirm-disband" class="buttons" style="display:none;">
            <button id="confirm-disband-yes" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
            <button id="confirm-disband-no" class="success">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp; 
        tg.ready(); 
        tg.expand();
        
        const params = new URLSearchParams(location.search);
        const prefilled = params.get('className');
        if (prefilled) document.getElementById('class-name').value = prefilled;
        const prefilledSub = parseInt(params.get('subgroups') || '');
        let currentSubgroups = (!Number.isNaN(prefilledSub) && prefilledSub >= 1 && prefilledSub <= 4) ? prefilledSub : 1;
        // –ù–µ–¥–µ–ª–∏ (–¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è): –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ü–Ω‚Äì–ü—Ç = [1,2,3,4,5]
        let currentWeekdays = [1,2,3,4,5];
        try {
            const wdRaw = params.get('weekdays');
            if (wdRaw) {
                const parsed = JSON.parse(wdRaw);
                if (Array.isArray(parsed)) {
                    const cleaned = parsed.map(x => parseInt(x, 10)).filter(n => Number.isInteger(n) && n >= 1 && n <= 7);
                    if (cleaned.length) currentWeekdays = Array.from(new Set(cleaned)).sort((a,b)=>a-b);
                }
            }
        } catch(e) { /* ignore */ }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type, targetId = 'status') {
            const status = document.getElementById(targetId);
            status.textContent = message;
            status.className = `status ${type}`;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            if (type !== 'loading') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = '';
                }, 3000);
            }
        }
        
        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–≥—Ä—É–ø–ø (radio)
        const subgroupsContainer = document.getElementById('subgroups-options');
        function syncRadios() {
            const radios = (subgroupsContainer ? Array.from(subgroupsContainer.querySelectorAll('input[type="radio"][name="subgroups"]')) : []);
            radios.forEach(r => {
                const val = parseInt(r.value || '0', 10);
                r.checked = (val === currentSubgroups);
            });
        }
        if (subgroupsContainer) {
            subgroupsContainer.addEventListener('change', (e) => {
                const target = e.target;
                if (target && target.type === 'radio' && target.name === 'subgroups') {
                    const val = parseInt(target.value || '0', 10);
                    if (Number.isInteger(val) && val >= 1 && val <= 4) {
                        currentSubgroups = val;
                        refreshButtonsState();
                    }
                }
            });
        }
        syncRadios();
        
        // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–æ–∫ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
        const saveNameBtn = document.getElementById('save-name');
        const saveSubsBtn = document.getElementById('save-subgroups');
        // saveWeekdaysBtn –æ–±—ä—è–≤–ª–µ–Ω –Ω–∏–∂–µ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ —Å–µ–∫—Ü–∏–∏
        function setDisabled(btn, disabled){
            if (!btn) return;
            if (disabled){ btn.classList.add('disabled'); btn.setAttribute('disabled', 'disabled'); }
            else { btn.classList.remove('disabled'); btn.removeAttribute('disabled'); }
        }
        const initial = {
            name: String(prefilled || '').trim(),
            subgroups: currentSubgroups,
            weekdays: [...currentWeekdays]
        };
        function isEqualWeekdays(a, b){
            if (!Array.isArray(a) || !Array.isArray(b)) return false;
            if (a.length !== b.length) return false;
            for (let i=0;i<a.length;i++){ if (a[i] !== b[i]) return false; }
            return true;
        }
        function refreshButtonsState(){
            const nameNow = String(document.getElementById('class-name').value || '').trim();
            setDisabled(saveNameBtn, nameNow === initial.name);
            setDisabled(saveSubsBtn, currentSubgroups === initial.subgroups);
            const wdNow = [...currentWeekdays].sort((a,b)=>a-b);
            const wdInit = [...initial.weekdays].sort((a,b)=>a-b);
            const saveWeekdaysBtnLocal = document.getElementById('save-weekdays');
            setDisabled(saveWeekdaysBtnLocal, isEqualWeekdays(wdNow, wdInit));
        }
        
        // UI –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ (—á–µ–∫–±–æ–∫—Å—ã)
        const weekdaysSection = document.createElement('div');
        weekdaysSection.className = 'section';
        weekdaysSection.innerHTML = `
            <h3>üìÖ –î–Ω–∏ –æ–±—É—á–µ–Ω–∏—è</h3>
            <div class="row" id="weekdays-options" style="gap:10px; flex-wrap:wrap;">
                <label><input type="checkbox" value="1"> –ü–Ω</label>
                <label><input type="checkbox" value="2"> –í—Ç</label>
                <label><input type="checkbox" value="3"> –°—Ä</label>
                <label><input type="checkbox" value="4"> –ß—Ç</label>
                <label><input type="checkbox" value="5"> –ü—Ç</label>
                <label><input type="checkbox" value="6"> –°–±</label>
                <label><input type="checkbox" value="7"> –í—Å</label>
            </div>
            <div class="buttons"><button id="save-weekdays">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
            <div id="status-weekdays"></div>
        `;
        // –í—Å—Ç–∞–≤–∏–º —Å–µ–∫—Ü–∏—é –ø–æ—Å–ª–µ –ø–æ–¥–≥—Ä—É–ø–ø
        const sections = document.querySelectorAll('.section');
        if (sections && sections[1]) {
            sections[1].insertAdjacentElement('afterend', weekdaysSection);
        } else {
            document.body.appendChild(weekdaysSection);
        }
        
        const weekdaysContainer = weekdaysSection.querySelector('#weekdays-options');
        function syncWeekdayCheckboxes() {
            const boxes = weekdaysContainer ? Array.from(weekdaysContainer.querySelectorAll('input[type="checkbox"]')) : [];
            boxes.forEach(cb => {
                const v = parseInt(cb.value || '0', 10);
                cb.checked = currentWeekdays.includes(v);
            });
        }
        syncWeekdayCheckboxes();
        
        if (weekdaysContainer) {
            weekdaysContainer.addEventListener('change', (e) => {
                const target = e.target;
                if (!target || target.type !== 'checkbox') return;
                const v = parseInt(target.value || '0', 10);
                if (!Number.isInteger(v) || v < 1 || v > 7) return;
                if (target.checked) {
                    if (!currentWeekdays.includes(v)) currentWeekdays.push(v);
                } else {
                    currentWeekdays = currentWeekdays.filter(n => n !== v);
                }
                currentWeekdays.sort((a,b)=>a-b);
                refreshButtonsState();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
        document.getElementById('save-name').onclick = () => {
            const name = document.getElementById('class-name').value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!name) {
                showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞', 'error');
                return;
            }
            
            if (name.length < 2) {
                showStatus('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞', 'error');
                return;
            }
            
            if (name.length > 50) {
                showStatus('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            showStatus('‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'loading');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            tg.sendData(JSON.stringify({ action:'set_class_name', name }));
            initial.name = name;
            refreshButtonsState();
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–≥—Ä—É–ø–ø
        document.getElementById('save-subgroups').onclick = () => {
            const count = currentSubgroups;
            if (!Number.isInteger(count) || count < 1 || count > 4) {
                showStatus('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–≥—Ä—É–ø–ø (1‚Äì4)', 'error', 'status-subgroups');
                return;
            }
            showStatus('‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'loading', 'status-subgroups');
            tg.sendData(JSON.stringify({ action: 'set_subgroups', count }));
            initial.subgroups = count;
            refreshButtonsState();
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('class-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('save-name').click();
            }
        });
        document.getElementById('class-name').addEventListener('input', refreshButtonsState);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–Ω–µ–π –æ–±—É—á–µ–Ω–∏—è
        const saveWeekdaysBtn = document.getElementById('save-weekdays');
        if (saveWeekdaysBtn) {
            saveWeekdaysBtn.onclick = () => {
                const normalized = Array.from(new Set(currentWeekdays.filter(n => Number.isInteger(n) && n>=1 && n<=7))).sort((a,b)=>a-b);
                if (normalized.length === 0) {
                    showStatus('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å', 'error', 'status-weekdays');
                    return;
                }
                showStatus('‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'loading', 'status-weekdays');
                tg.sendData(JSON.stringify({ action: 'set_weekdays', weekdays: normalized }));
                initial.weekdays = [...normalized];
                refreshButtonsState();
            };
        }

        // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ —Å–∞–π—Ç–µ)
        const disbandToggle = document.getElementById('disband-toggle');
        const confirmDisband = document.getElementById('confirm-disband');
        const confirmYes = document.getElementById('confirm-disband-yes');
        const confirmNo = document.getElementById('confirm-disband-no');

        if (disbandToggle && confirmDisband && confirmYes && confirmNo) {
            disbandToggle.onclick = () => {
                confirmDisband.style.display = 'flex';
                disbandToggle.classList.add('disabled');
            };

            confirmNo.onclick = () => {
                confirmDisband.style.display = 'none';
                disbandToggle.classList.remove('disabled');
            };

            confirmYes.onclick = () => {
                showStatus('‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞...', 'loading');
                tg.sendData(JSON.stringify({ action: 'disband_class' }));
            };
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
        refreshButtonsState();
    </script>
</body>
</html>
