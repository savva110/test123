<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–ª–∞—Å—Å ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin:0; padding:16px; background: var(--tg-theme-bg-color,#fff); color: var(--tg-theme-text-color,#000); }
        h1 { margin: 0 0 12px; font-size: 20px; }
        .section { background: var(--tg-theme-secondary-bg-color,#f5f5f5); border-radius: 12px; padding: 14px; border-left: 4px solid var(--tg-theme-button-color,#2481cc); margin-bottom: 12px; }
        .row { display:flex; gap:8px; align-items:center; }
        input[type="text"], input[type="time"] { flex: 1; padding: 10px; border: 2px solid var(--tg-theme-hint-color,#ccc); border-radius: 10px; font-size: 14px; }
        .buttons { display:flex; gap:8px; margin-top: 12px; }
        .buttons button { background: var(--tg-theme-button-color,#2481cc); color: var(--tg-theme-button-text-color,#fff); border:none; padding:12px 14px; border-radius:10px; }
        .ghost { background: transparent; color: var(--tg-theme-button-color,#2481cc); border:1px solid var(--tg-theme-button-color,#2481cc); }
        .disabled { opacity:.6; pointer-events:none; }
        .danger { background: #e53935 !important; color: #fff; }
        .success { background: #43a047 !important; color: #fff; }
        .status { margin-top: 12px; padding: 10px; border-radius: 8px; text-align: center; font-weight: 500; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.loading { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        /* Pointer cursor on interactive elements */
        .buttons button, button, input[type="checkbox"] { cursor: pointer; }
        
        /* Footer styles */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--tg-theme-bg-color,#fff); padding: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); z-index: 10; }
        #save-all { display: block; width: 100%; text-decoration: none; text-align: center; background: var(--tg-theme-button-color,#2481cc); color: var(--tg-theme-button-text-color,#fff); padding: 12px; border-radius: 12px; border: none; font-size: 14px; cursor: pointer; }
        #save-all.disabled { opacity: .6; pointer-events: none; }
        body { padding-bottom: 80px; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>üè∑Ô∏è –ö–ª–∞—Å—Å</h1>
    <div class="section">
        <h3>üìù –ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞</h3>
        <div class="row"><input id="class-name" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 7–ê" maxlength="50"></div>
        <div id="status"></div>
    </div>
    <div class="section">
        <h3>üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–≥—Ä—É–ø–ø</h3>
        <div class="row" id="subgroups-options" style="gap:6px;">
            <label><input type="radio" name="subgroups" value="1"> 1</label>
            <label><input type="radio" name="subgroups" value="2"> 2</label>
            <label><input type="radio" name="subgroups" value="3"> 3</label>
            <label><input type="radio" name="subgroups" value="4"> 4</label>
        </div>
        <div id="status-subgroups"></div>
    </div>
    <div class="section">
        <h3>‚ö†Ô∏è –†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å</h3>
        <p>–î–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –∫–ª–∞—Å—Å –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
        <div class="buttons">
            <button id="disband-toggle" class="ghost">–†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å</button>
        </div>
        <div id="confirm-disband" class="buttons" style="display:none;">
            <button id="confirm-disband-yes" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
            <button id="confirm-disband-no" class="success">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
        </div>
    </div>
    
    <!-- Footer with save button -->
    <div class="footer">
        <button id="save-all">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    
    <script>
        const tg = window.Telegram.WebApp; 
        tg.ready(); 
        tg.expand();
        
        const params = new URLSearchParams(location.search);
        const prefilled = params.get('className');
        if (prefilled) document.getElementById('class-name').value = prefilled;
        const prefilledSub = parseInt(params.get('subgroups') || '');
        let currentSubgroups = (!Number.isNaN(prefilledSub) && prefilledSub >= 1 && prefilledSub <= 4) ? prefilledSub : 1;
        // –ù–µ–¥–µ–ª–∏ (–¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è): –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ü–Ω‚Äì–ü—Ç = [1,2,3,4,5]
        let currentWeekdays = [1,2,3,4,5];
        try {
            const wdRaw = params.get('weekdays');
            if (wdRaw) {
                const parsed = JSON.parse(wdRaw);
                if (Array.isArray(parsed)) {
                    const cleaned = parsed.map(x => parseInt(x, 10)).filter(n => Number.isInteger(n) && n >= 1 && n <= 7);
                    if (cleaned.length) currentWeekdays = Array.from(new Set(cleaned)).sort((a,b)=>a-b);
                }
            }
        } catch(e) { /* ignore */ }
        // –í—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö (–º–∞—Å—Å–∏–≤)
        let currentAbsenceTimes = [];
        try {
            const timeRaw = params.get('absence_notification_time');
            console.log('URL –ø–∞—Ä–∞–º–µ—Ç—Ä absence_notification_time:', timeRaw);
            if (timeRaw) {
                const parsed = JSON.parse(timeRaw);
                console.log('–†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:', parsed);
                if (Array.isArray(parsed)) {
                    currentAbsenceTimes = parsed.filter(t => typeof t === 'string' && t.trim());
                    console.log('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', currentAbsenceTimes);
                } else if (typeof parsed === 'string' && parsed.trim()) {
                    currentAbsenceTimes = [parsed.trim()];
                    console.log('–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ –º–∞—Å—Å–∏–≤:', currentAbsenceTimes);
                }
            } else {
                console.log('absence_notification_time –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö');
            }
        } catch(e) { 
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ absence_notification_time:', e);
        }
        console.log('–§–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ currentAbsenceTimes:', currentAbsenceTimes);
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type, targetId = 'status') {
            const status = document.getElementById(targetId);
            status.textContent = message;
            status.className = `status ${type}`;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            if (type !== 'loading') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = '';
                }, 3000);
            }
        }
        
        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–≥—Ä—É–ø–ø (radio)
        const subgroupsContainer = document.getElementById('subgroups-options');
        function syncRadios() {
            const radios = (subgroupsContainer ? Array.from(subgroupsContainer.querySelectorAll('input[type="radio"][name="subgroups"]')) : []);
            radios.forEach(r => {
                const val = parseInt(r.value || '0', 10);
                r.checked = (val === currentSubgroups);
            });
        }
        if (subgroupsContainer) {
            subgroupsContainer.addEventListener('change', (e) => {
                const target = e.target;
                if (target && target.type === 'radio' && target.name === 'subgroups') {
                    const val = parseInt(target.value || '0', 10);
                    if (Number.isInteger(val) && val >= 1 && val <= 4) {
                        currentSubgroups = val;
                        refreshButtonsState();
                    }
                }
            });
        }
        syncRadios();
        
        // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
        const saveAllBtn = document.getElementById('save-all');
        function setDisabled(btn, disabled){
            if (!btn) return;
            if (disabled){ btn.classList.add('disabled'); btn.setAttribute('disabled', 'disabled'); }
            else { btn.classList.remove('disabled'); btn.removeAttribute('disabled'); }
        }
        const initial = {
            name: String(prefilled || '').trim(),
            subgroups: currentSubgroups,
            weekdays: [...currentWeekdays],
            absenceTimes: [...currentAbsenceTimes]
        };
        function isEqualWeekdays(a, b){
            if (!Array.isArray(a) || !Array.isArray(b)) return false;
            if (a.length !== b.length) return false;
            for (let i=0;i<a.length;i++){ if (a[i] !== b[i]) return false; }
            return true;
        }
        function refreshButtonsState(){
            const nameNow = String(document.getElementById('class-name').value || '').trim();
            const wdNow = [...currentWeekdays].sort((a,b)=>a-b);
            const wdInit = [...initial.weekdays].sort((a,b)=>a-b);
            const timesNow = [...currentAbsenceTimes].sort();
            const timesInit = [...initial.absenceTimes].sort();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª—é–±–æ–º –∏–∑ –ø–æ–ª–µ–π
            const hasNameChanges = nameNow !== initial.name;
            const hasSubgroupsChanges = currentSubgroups !== initial.subgroups;
            const hasWeekdaysChanges = !isEqualWeekdays(wdNow, wdInit);
            const hasTimeChanges = !isEqualWeekdays(timesNow, timesInit);
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
            const hasAnyChanges = hasNameChanges || hasSubgroupsChanges || hasWeekdaysChanges || hasTimeChanges;
            setDisabled(saveAllBtn, !hasAnyChanges);
        }
        
        // UI –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ (—á–µ–∫–±–æ–∫—Å—ã)
        const weekdaysSection = document.createElement('div');
        weekdaysSection.className = 'section';
        weekdaysSection.innerHTML = `
            <h3>üìÖ –î–Ω–∏ –æ–±—É—á–µ–Ω–∏—è</h3>
            <div class="row" id="weekdays-options" style="gap:10px; flex-wrap:wrap;">
                <label><input type="checkbox" value="1"> –ü–Ω</label>
                <label><input type="checkbox" value="2"> –í—Ç</label>
                <label><input type="checkbox" value="3"> –°—Ä</label>
                <label><input type="checkbox" value="4"> –ß—Ç</label>
                <label><input type="checkbox" value="5"> –ü—Ç</label>
                <label><input type="checkbox" value="6"> –°–±</label>
                <label><input type="checkbox" value="7"> –í—Å</label>
            </div>
            <div id="status-weekdays"></div>
        `;
        // –í—Å—Ç–∞–≤–∏–º —Å–µ–∫—Ü–∏—é –ø–æ—Å–ª–µ –ø–æ–¥–≥—Ä—É–ø–ø
        const sections = document.querySelectorAll('.section');
        if (sections && sections[1]) {
            sections[1].insertAdjacentElement('afterend', weekdaysSection);
        } else {
            document.body.appendChild(weekdaysSection);
        }
        
        // UI –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö
        const absenceTimeSection = document.createElement('div');
        absenceTimeSection.className = 'section';
        absenceTimeSection.innerHTML = `
            <h3>‚è∞ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö</h3>
            <p style="font-size: 13px; margin: 8px 0; opacity: 0.8;">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, –∫—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
            <div id="absence-times-container"></div>
            <div style="margin-top: 8px; display: flex; gap: 8px;">
                <button id="add-absence-time" style="background: var(--tg-theme-button-color,#2481cc); color: var(--tg-theme-button-text-color,#fff); border: none; padding: 10px 14px; border-radius: 10px; font-size: 13px; cursor: pointer;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è</button>
                <button id="clear-all-absence-times" style="background: #e53935; color: #fff; border: none; padding: 10px 14px; border-radius: 10px; font-size: 13px; cursor: pointer;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
            </div>
            <div id="status-absence-time"></div>
        `;
        // –í—Å—Ç–∞–≤–∏–º —Å–µ–∫—Ü–∏—é –ø–æ—Å–ª–µ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
        weekdaysSection.insertAdjacentElement('afterend', absenceTimeSection);
        
        const absenceTimesContainer = document.getElementById('absence-times-container');
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–æ–ª–µ–π –≤—Ä–µ–º–µ–Ω–∏
        function renderAbsenceTimes() {
            if (!absenceTimesContainer) return;
            absenceTimesContainer.innerHTML = '';
            
            if (currentAbsenceTimes.length === 0) {
                absenceTimesContainer.innerHTML = '<p style="font-size: 13px; opacity: 0.6; margin: 8px 0;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã</p>';
                return;
            }
            
            currentAbsenceTimes.forEach((time, index) => {
                const timeRow = document.createElement('div');
                timeRow.style.display = 'flex';
                timeRow.style.gap = '8px';
                timeRow.style.marginBottom = '8px';
                timeRow.style.alignItems = 'center';
                
                const timeInput = document.createElement('input');
                timeInput.type = 'time';
                timeInput.value = time;
                timeInput.style.flex = '1';
                timeInput.style.padding = '10px';
                timeInput.style.border = '2px solid var(--tg-theme-hint-color,#ccc)';
                timeInput.style.borderRadius = '10px';
                timeInput.style.fontSize = '14px';
                timeInput.dataset.index = index;
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '‚úñÔ∏è';
                removeBtn.style.background = '#e53935';
                removeBtn.style.color = '#fff';
                removeBtn.style.border = 'none';
                removeBtn.style.padding = '10px 14px';
                removeBtn.style.borderRadius = '10px';
                removeBtn.style.fontSize = '14px';
                removeBtn.style.minWidth = '45px';
                removeBtn.style.cursor = 'pointer';
                removeBtn.dataset.index = index;
                
                timeRow.appendChild(timeInput);
                timeRow.appendChild(removeBtn);
                absenceTimesContainer.appendChild(timeRow);
            });
        }
        
        renderAbsenceTimes();
        
        // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π –≤—Ä–µ–º–µ–Ω–∏
        if (absenceTimesContainer) {
            absenceTimesContainer.addEventListener('change', (e) => {
                if (e.target.type === 'time') {
                    const index = parseInt(e.target.dataset.index);
                    const newValue = e.target.value;
                    
                    if (!isNaN(index) && index >= 0 && index < currentAbsenceTimes.length) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                        const duplicateIndex = currentAbsenceTimes.findIndex((time, i) => i !== index && time === newValue);
                        
                        if (duplicateIndex !== -1) {
                            // –ï—Å–ª–∏ —Ç–∞–∫–æ–µ –≤—Ä–µ–º—è —É–∂–µ –µ—Å—Ç—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            showStatus(`‚ùå –í—Ä–µ–º—è ${newValue} —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ`, 'error', 'status-absence-time');
                            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                            e.target.value = currentAbsenceTimes[index];
                            return;
                        }
                        
                        currentAbsenceTimes[index] = newValue;
                        refreshButtonsState();
                    }
                }
            });
            
            absenceTimesContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-index]');
                if (btn) {
                    const index = parseInt(btn.dataset.index);
                    if (!isNaN(index) && index >= 0 && index < currentAbsenceTimes.length) {
                        currentAbsenceTimes.splice(index, 1);
                        renderAbsenceTimes();
                        refreshButtonsState();
                    }
                }
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        const addAbsenceTimeBtn = document.getElementById('add-absence-time');
        if (addAbsenceTimeBtn) {
            addAbsenceTimeBtn.addEventListener('click', () => {
                // –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è (–∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
                let newTime = '09:00';
                let hour = 9;
                
                // –ò—â–µ–º –ø–µ—Ä–≤–æ–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∏–Ω–∞—è —Å 09:00
                while (currentAbsenceTimes.includes(newTime) && hour < 24) {
                    hour++;
                    newTime = `${hour.toString().padStart(2, '0')}:00`;
                }
                
                // –ï—Å–ª–∏ –≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –∑–∞–Ω—è—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π —á–∞—Å
                if (currentAbsenceTimes.includes(newTime)) {
                    // –ï—Å–ª–∏ —É–∂–µ 24 —á–∞—Å–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã, –±–µ—Ä–µ–º –º–∏–Ω—É—Ç—ã
                    for (let h = 0; h < 24; h++) {
                        for (let m = 0; m < 60; m += 30) {
                            const testTime = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                            if (!currentAbsenceTimes.includes(testTime)) {
                                newTime = testTime;
                                break;
                            }
                        }
                        if (!currentAbsenceTimes.includes(newTime)) break;
                    }
                }
                
                currentAbsenceTimes.push(newTime);
                renderAbsenceTimes();
                refreshButtonsState();
            });
        }
        
        // –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω
        const clearAllAbsenceTimesBtn = document.getElementById('clear-all-absence-times');
        if (clearAllAbsenceTimesBtn) {
            clearAllAbsenceTimesBtn.addEventListener('click', () => {
                currentAbsenceTimes = [];
                renderAbsenceTimes();
                refreshButtonsState();
            });
        }
        
        const weekdaysContainer = weekdaysSection.querySelector('#weekdays-options');
        function syncWeekdayCheckboxes() {
            const boxes = weekdaysContainer ? Array.from(weekdaysContainer.querySelectorAll('input[type="checkbox"]')) : [];
            boxes.forEach(cb => {
                const v = parseInt(cb.value || '0', 10);
                cb.checked = currentWeekdays.includes(v);
            });
        }
        syncWeekdayCheckboxes();
        
        if (weekdaysContainer) {
            weekdaysContainer.addEventListener('change', (e) => {
                const target = e.target;
                if (!target || target.type !== 'checkbox') return;
                const v = parseInt(target.value || '0', 10);
                if (!Number.isInteger(v) || v < 1 || v > 7) return;
                if (target.checked) {
                    if (!currentWeekdays.includes(v)) currentWeekdays.push(v);
                } else {
                    currentWeekdays = currentWeekdays.filter(n => n !== v);
                }
                currentWeekdays.sort((a,b)=>a-b);
                refreshButtonsState();
            });
        }
        
        // –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        document.getElementById('save-all').onclick = () => {
            const name = document.getElementById('class-name').value.trim();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞
            if (!name) {
                showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞', 'error');
                return;
            }
            
            if (name.length < 2) {
                showStatus('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞', 'error');
                return;
            }
            
            if (name.length > 50) {
                showStatus('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 50 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥–≥—Ä—É–ø–ø
            if (!Number.isInteger(currentSubgroups) || currentSubgroups < 1 || currentSubgroups > 4) {
                showStatus('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–≥—Ä—É–ø–ø (1‚Äì4)', 'error');
                return;
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
            const normalized = Array.from(new Set(currentWeekdays.filter(n => Number.isInteger(n) && n>=1 && n<=7))).sort((a,b)=>a-b);
            if (normalized.length === 0) {
                showStatus('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å –æ–±—É—á–µ–Ω–∏—è', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            showStatus('‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'loading');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
            const payload = { 
                action: 'save_class_settings',
                name: name,
                subgroups: currentSubgroups,
                weekdays: normalized
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –≤—Ä–µ–º–µ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –≤—Ä–µ–º–µ–Ω–∞ –∏ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
            const validTimes = [...new Set(currentAbsenceTimes.filter(t => t && t.trim()))];
            if (validTimes.length > 0) {
                payload.absence_notification_time = validTimes;
            } else {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
                payload.absence_notification_time = [];
            }
            
            tg.sendData(JSON.stringify(payload));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            initial.name = name;
            initial.subgroups = currentSubgroups;
            initial.weekdays = [...normalized];
            initial.absenceTimes = [...validTimes];
            refreshButtonsState();
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('class-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('save-all').click();
            }
        });
        document.getElementById('class-name').addEventListener('input', refreshButtonsState);

        // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ —Å–∞–π—Ç–µ)
        const disbandToggle = document.getElementById('disband-toggle');
        const confirmDisband = document.getElementById('confirm-disband');
        const confirmYes = document.getElementById('confirm-disband-yes');
        const confirmNo = document.getElementById('confirm-disband-no');

        if (disbandToggle && confirmDisband && confirmYes && confirmNo) {
            disbandToggle.onclick = () => {
                confirmDisband.style.display = 'flex';
                disbandToggle.classList.add('disabled');
            };

            confirmNo.onclick = () => {
                confirmDisband.style.display = 'none';
                disbandToggle.classList.remove('disabled');
            };

            confirmYes.onclick = () => {
                showStatus('‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞...', 'loading');
                tg.sendData(JSON.stringify({ action: 'disband_class' }));
            };
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
        refreshButtonsState();
    </script>
</body>
</html>
