<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Telegram WebApp ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è</title>
    <style>
        :root{
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #0b1220);
            --muted: #6b7280;
            --card: var(--tg-theme-secondary-bg-color, #f3f4f6);
            --btn: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
        }
        html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
        body{background:var(--bg);color:var(--text);padding:18px;box-sizing:border-box;}
        .container{max-width:720px;margin:0 auto;}
        header{display:flex;gap:12px;align-items:center;margin-bottom:18px;}
        h1{font-size:20px;margin:0;}
        .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:12px;}
        .user-card{display:flex;flex-direction:column;gap:6px}
        label{font-weight:600;font-size:13px;margin-bottom:6px;display:block}
        textarea{width:100%;min-height:96px;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);resize:vertical;font-size:15px}
        .controls{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
        button{background:var(--btn);color:var(--btn-text);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
        .secondary{background:transparent;border:1px solid rgba(0,0,0,0.08);color:var(--text)}
        .features{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
        .status{margin-top:12px;padding:10px;border-radius:8px;font-weight:600}
        .status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
        .status.loading{background:#fff3cd;color:#856404;border:1px solid #ffeeba}
        footer{margin-top:18px;font-size:13px;color:var(--muted)}
        .hidden{display:none}
        @media(max-width:560px){
            .features{grid-template-columns:1fr}
        }
        .warning{background:#fff7ed;border:1px solid #ffe4c4;padding:10px;border-radius:8px;color:#6b4a00}
        .small{font-size:13px;color:var(--muted)}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ WebApp ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è</h1>
        </header>

        <div id="app" class="card hidden">
            <div id="user-info" class="user-card"></div>

            <label for="messageText">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea id="messageText" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..."></textarea>

            <div class="controls">
                <button id="sendBtn">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å (–±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è)</button>
                <button id="sendTimeBtn" class="secondary">üïí –í—Ä–µ–º—è</button>
                <button id="sendRandBtn" class="secondary">üé≤ –°–ª—É—á–∞–π–Ω–æ–µ</button>
            </div>

            <div class="features">
                <div class="small">–¢–µ–∫—É—â–∏–π URL: <code id="current-url"></code></div>
                <div class="small" id="client-support">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞: ‚Äî</div>
            </div>

            <div id="status" class="status hidden"></div>

            <div style="margin-top:12px" class="small">
                –î–∞–Ω–Ω—ã–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ <code>tg.postEvent("web_app_data")</code> ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
                –ï—Å–ª–∏ –≤–∞—à –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç <code>postEvent</code>, —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–π <code>sendData</code> (–≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ WebApp –∑–∞–∫—Ä–æ–µ—Ç—Å—è).
            </div>
        </div>

        <div id="login-warning" class="card">
            <div class="warning">
                ‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram (—á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ). –°–µ–π—á–∞—Å –≤—ã –≤–∏–¥–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑–≤–Ω–µ –∏–ª–∏ –≤–∞—à –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ Telegram.
            </div>
            <div style="margin-top:10px">
                <div>–¢–µ–∫—É—â–∏–π URL: <code id="current-url-warning"></code></div>
                <div style="margin-top:8px" class="small">–ï—Å–ª–∏ –≤—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç–µ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –º–Ω–æ–≥–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Telegram WebApp —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥—É—Ç.</div>
            </div>
        </div>

        <footer>
            <div class="small">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–º –∫–æ–¥–µ. –≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.</div>
        </footer>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram WebApp API –æ–±—ä–µ–∫—Ç
        const tg = window.Telegram?.WebApp;
        const statusEl = document.getElementById('status');
        const appEl = document.getElementById('app');
        const warningEl = document.getElementById('login-warning');
        const currentUrlEl = document.getElementById('current-url');
        const currentUrlWarn = document.getElementById('current-url-warning');
        const clientSupportEl = document.getElementById('client-support');

        // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ –ø–∞–º—è—Ç–∏ + localStorage)
        const LOCAL_KEY = 'webapp_messages_v1';
        let buffer = loadBuffer();

        function loadBuffer(){
            try {
                const raw = localStorage.getItem(LOCAL_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch(e){
                return [];
            }
        }
        function saveBuffer(){
            try{ localStorage.setItem(LOCAL_KEY, JSON.stringify(buffer)); } catch(e){}
        }

        function showStatus(text, type='success', auto=true){
            statusEl.textContent = text;
            statusEl.className = 'status ' + (type || '');
            statusEl.classList.remove('hidden');
            if(auto && type !== 'loading'){
                setTimeout(()=>{ statusEl.className = 'status hidden'; statusEl.textContent=''; }, 3000);
            }
        }

        function initApp(){
            currentUrlEl.textContent = window.location.href;
            currentUrlWarn.textContent = window.location.href;

            // –ï—Å–ª–∏ Telegram –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª initDataUnsafe.user ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ WebApp –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ Telegram
            const isTelegram = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
            if(!isTelegram){
                // –Ω–µ –≤ Telegram ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                warningEl.classList.remove('hidden');
                appEl.classList.add('hidden');
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram UI –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            warningEl.classList.add('hidden');
            appEl.classList.remove('hidden');

            const user = tg.initDataUnsafe.user;
            renderUserInfo(user);

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MainButton ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            try {
                tg.MainButton.setText("–û—Ç–ø—Ä–∞–≤–∏—Ç—å (–±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è)");
                tg.MainButton.show();
                tg.MainButton.onClick(() => sendMessage());
            } catch(e){ /*ignore*/ }

            // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ postEvent ‚Äî –ø–æ–º–µ—Ç–∏—Ç—å
            const supportsPostEvent = typeof tg.postEvent === 'function';
            clientSupportEl.textContent = supportsPostEvent ? 'postEvent: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚úÖ' : 'postEvent: –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω sendData (–∑–∞–∫—Ä–æ–µ—Ç WebApp) ‚ö†Ô∏è';

            // —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ UI
            try { tg.expand(); } catch(e){}

            // —Å–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Å –±–æ—Ç–∞ (–µ—Å–ª–∏ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è)
            try {
                tg.onEvent && tg.onEvent('web_app_close', () => console.log('web_app_close'));
            } catch(e){}
        }

        function renderUserInfo(user){
            const node = document.getElementById('user-info');
            node.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;">
                    <div style="flex:1">
                        <div style="font-weight:700">üë§ ${escapeHtml(user.first_name || '')} ${escapeHtml(user.last_name || '')}</div>
                        <div class="small">ID: <code>${user.id}</code> ${user.username ? `‚Ä¢ @${escapeHtml(user.username)}` : ''}</div>
                    </div>
                </div>
            `;
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–π HTML
        function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

        // –°–æ–±—Ä–∞—Ç—å –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö, –¥–æ–±–∞–≤–∏—Ç—å –≤ –±—É—Ñ–µ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ postEvent (–∏–ª–∏ sendData –∫–∞–∫ fallback)
        async function sendMessage(){
            const textEl = document.getElementById('messageText');
            const text = textEl.value.trim();
            if(!text){
                showStatus('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                return;
            }

            const payload = {
                action: 'send_message',
                text,
                timestamp: new Date().toISOString(),
                // –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –∫–ª–∏–µ–Ω—Ç–∞, id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç.–ø.
                client: { platform: tg?.platform || null, version: tg?.version || null }
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä
            buffer.push(payload);
            saveBuffer();

            showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞...', 'loading', false);

            // –ï—Å–ª–∏ postEvent –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ (–Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
            if(typeof tg.postEvent === 'function'){
                try {
                    // —Å–æ–±—ã—Ç–∏–µ –º–æ–∂–Ω–æ –Ω–∞–∑–≤–∞—Ç—å –ª—é–±—ã–º; —Å–µ—Ä–≤–µ—Ä/–±–æ—Ç –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –µ–≥–æ —á–∏—Ç–∞—Ç—å (–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö/—Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–æ—á–µ—Ç–∞–Ω–∏—è—Ö —Å–æ–±—ã—Ç–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ update –¥–ª—è –±–æ—Ç–∞)
                    tg.postEvent('web_app_data', JSON.stringify(payload));
                    showStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (postEvent). –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—ã–º.', 'success');
                    textEl.value = '';
                    return;
                } catch (e){
                    console.error('postEvent error', e);
                }
            }

            // fallback: tg.sendData (–∑–∞–∫—Ä–æ–µ—Ç WebApp)
            if(typeof tg.sendData === 'function'){
                try {
                    tg.sendData(JSON.stringify(payload));
                    // –ü–æ—Å–ª–µ sendData –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä–æ–µ—Ç—Å—è ‚Äî –Ω–æ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –∑–∞–∫—Ä—ã–ª—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ:
                    showStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (sendData). –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å—Å—è.', 'success', false);
                    textEl.value = '';
                    return;
                } catch(e){
                    console.error('sendData error', e);
                }
            }

            // –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ
            showStatus('–û—à–∏–±–∫–∞: –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–µ', 'error');
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function sendTime(){ 
            const time = new Date().toLocaleString('ru-RU', { hour:'2-digit',minute:'2-digit',second:'2-digit', day:'2-digit', month:'long', year:'numeric' });
            document.getElementById('messageText').value = `üïí –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${time}`;
            sendMessage();
        }
        function sendRand(){
            const r = Math.floor(Math.random()*100)+1;
            document.getElementById('messageText').value = `üé≤ –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ: ${r}`;
            sendMessage();
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–æ–∫
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('sendTimeBtn').addEventListener('click', sendTime);
        document.getElementById('sendRandBtn').addEventListener('click', sendRand);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
